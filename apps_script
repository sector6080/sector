// Configurazione
var SHEET_ID = '1djpONz3rJtEce-bl4Wsy1q46NRl1jTMC3uKxN1hQMng'; // Il tuo foglio esistente
var RESPONSE_SHEET_NAME = 'Risposte del modulo 1'; // Foglio delle risposte del form

// INSTALLAZIONE TRIGGER - Da eseguire una volta manualmente
function installTrigger() {
  ScriptApp.newTrigger('onFormSubmit')
    .timeBased()
    .everyMinutes(1) // Controlla ogni minuto
    .create();
  
  console.log('Trigger installato!');
}

// TRIGGER AUTOMATICO per ogni nuova risposta
function onFormSubmit() {
  try {
    console.log('Trigger attivato - controllo nuove risposte...');
    processAllFormResponses();
  } catch (error) {
    console.error('Errore nel trigger:', error.toString());
  }
}

// TRIGGER ALTERNATIVO - Si attiva ad ogni modifica del foglio
function installOnEditTrigger() {
  ScriptApp.newTrigger('onSheetEdit')
    .forSpreadsheet(SHEET_ID)
    .onEdit()
    .create();
  
  console.log('Trigger onEdit installato!');
}

function onSheetEdit(e) {
  // Controlla se la modifica è nel foglio delle risposte
  var sheet = e.source.getActiveSheet();
  if (sheet.getName() === RESPONSE_SHEET_NAME) {
    console.log('Modifica rilevata nel foglio risposte');
    // Aspetta 2 secondi per evitare conflitti
    Utilities.sleep(2000);
    processAllFormResponses();
  }
}

function doPost(e) {
  try {
    // Gestione CORS per preflight
    if (e && e.parameter && e.parameter.method === 'OPTIONS') {
      return ContentService.createTextOutput('')
        .setMimeType(ContentService.MimeType.TEXT);
    }
    
    // Gestione da Google Forms - Legge dalla colonna B del foglio risposte
    if (e.postData && e.postData.type === 'application/x-www-form-urlencoded') {
      var result = processAllFormResponses();
      
      // Avvia anche il processamento asincrono per sicurezza
      processAllFormResponsesAsync();
      
      return result;
    }
    
    // Gestione normale da fetch
    if (e.postData && e.postData.type === 'application/json') {
      var data = JSON.parse(e.postData.contents);
      var action = data.action;
      
      if (action === 'register') {
        return registerUnit(data.data);
      } else if (action === 'submitOrder') {
        return submitOrder(data.data);
      }
    }
    
    return createResponse({success: false, message: 'Richiesta non valida'});
    
  } catch (error) {
    return createResponse({success: false, message: error.toString()});
  }
}

// Processa tutte le risposte dal foglio del modulo - VERSIONE MIGLIORATA
function processAllFormResponses() {
  try {
    console.log('Inizio processamento risposte...');
    var responseSheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(RESPONSE_SHEET_NAME);
    var mainSheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    
    // Usa una colonna di tracking per evitare duplicati
    var lastProcessedColumn = 20; // Colonna T per tracking
    var processedMarker = 'PROCESSATO';
    
    var responses = responseSheet.getRange('B2:B' + responseSheet.getLastRow()).getValues();
    var processedStatus = responseSheet.getRange('T2:T' + responseSheet.getLastRow()).getValues();
    
    var processedCount = 0;
    var errors = [];
    
    for (var i = 0; i < responses.length; i++) {
      var formText = responses[i][0];
      var isProcessed = processedStatus[i][0] === processedMarker;
      
      // Salta righe vuote o già processate
      if (!formText || formText === '' || isProcessed) continue;
      
      try {
        console.log('Processando riga ' + (i + 2) + ': ' + formText.substring(0, 50) + '...');
        
        // Processa ogni risposta
        if (formText.includes('REGISTRAZIONE')) {
          processRegistrationFromForm(formText);
        } else if (formText.includes('ORDINE')) {
          processOrderFromForm(formText);
        } else {
          saveRawFormData(formText);
        }
        
        // Marca come processato
        responseSheet.getRange(i + 2, lastProcessedColumn).setValue(processedMarker);
        processedCount++;
        
        // Piccola pausa per evitare limiti di Google
        if (processedCount % 10 === 0) {
          Utilities.sleep(1000);
        }
        
      } catch (error) {
        var errorMsg = 'Riga ' + (i + 2) + ': ' + error.toString();
        console.error(errorMsg);
        errors.push(errorMsg);
        
        // Marca come errore
        responseSheet.getRange(i + 2, lastProcessedColumn).setValue('ERRORE: ' + error.toString().substring(0, 50));
      }
    }
    
    var resultMessage = 'Processate ' + processedCount + ' nuove risposte';
    if (errors.length > 0) {
      resultMessage += ' con ' + errors.length + ' errori';
    }
    
    console.log(resultMessage);
    
    return createResponse({
      success: true, 
      message: resultMessage,
      processed: processedCount,
      errors: errors.length > 0 ? errors : null
    });
    
  } catch (error) {
    console.error('Errore generale processamento:', error);
    return createResponse({success: false, message: error.toString()});
  }
}

// Versione asincrona per trigger
function processAllFormResponsesAsync() {
  try {
    // Crea un trigger temporaneo per evitare timeout
    ScriptApp.newTrigger('processAllFormResponsesBackground')
      .timeBased()
      .after(1000) // 1 secondo
      .create();
  } catch (error) {
    console.error('Errore creazione trigger asincrono:', error);
  }
}

function processAllFormResponsesBackground() {
  // Rimuovi il trigger temporaneo
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'processAllFormResponsesBackground') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // Esegui il processamento
  processAllFormResponses();
}

// FUNZIONE PER TESTARE MANUALMENTE
function testProcessResponses() {
  console.log('Test avviato...');
  var result = processAllFormResponses();
  console.log('Risultato test:', result);
  return result;
}

// FUNZIONE PER RESETTARE STATO PROCESSAMENTO
function resetProcessingStatus() {
  var responseSheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(RESPONSE_SHEET_NAME);
  var lastRow = responseSheet.getLastRow();
  
  if (lastRow > 1) {
    responseSheet.getRange('T2:T' + lastRow).clearContent();
    console.log('Stato processamento resettato');
  }
}

// [MANTIENI TUTTE LE ALTRE FUNZIONI ESISTENTI...]
// processRegistrationFromForm, processOrderFromForm, registerUnit, submitOrder, 
// extractValue, saveRawFormData, createResponse - RIMANGONO UGUALI

// Processa registrazione dal form testo
function processRegistrationFromForm(formText) {
  try {
    // Estrai i dati dal testo
    var matricola = extractValue(formText, 'Matricola:');
    var nick = extractValue(formText, 'Nick:');
    var tipo = extractValue(formText, 'Tipo:');
    var movimento = extractValue(formText, 'Movimento:');
    var visione = extractValue(formText, 'Visione:');
    var armatura = extractValue(formText, 'Armatura:');
    var rifornimenti = extractValue(formText, 'Rifornimenti:');
    
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    // Trova la prima riga vuota
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][1] || data[i][1] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    // Compila i dati nella riga
    sheet.getRange(rowIndex + 1, 1, 1, 12).setValues([[
      'NO', // approvata
      matricola || 'N/A',
      '1', // Password hashed dall'HTML
      nick || 'N/A',
      tipo || 'N/A',
      'N/A', // posizione
      movimento || 'N/A',
      visione || 'N/A',
      armatura || 'N/A',
      (rifornimenti || 'N/A') + '/' + (rifornimenti || 'N/A'),
      'N/A', // trasportata
      'N/A'  // componenti
    ]]);
    
    console.log('Registrazione processata: ' + matricola);
    return {success: true, message: 'Unità registrata dal form: ' + matricola};
  } catch (error) {
    throw new Error('Errore registrazione: ' + error.toString());
  }
}

// Processa ordine dal form testo
function processOrderFromForm(formText) {
  try {
    // Estrai i dati dal testo
    var matricola = extractValue(formText, 'Matricola:');
    var tipoOrdine = extractValue(formText, 'Tipo:');
    var dettagli = extractValue(formText, 'Dettagli:');
    var target = extractValue(formText, 'Target:');
    var quantità = extractValue(formText, 'Quantità:');
    
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][14] || data[i][14] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    var movimento = 'N/A';
    var salireScendere = 'N/A';
    var componenti = 'N/A';
    var rifornimenti = 'N/A';
    
    switch (tipoOrdine) {
      case 'muoversi':
        movimento = dettagli || 'N/A';
        break;
      case 'salire':
        salireScendere = 'salire(' + (dettagli || 'N/A') + ')';
        break;
      case 'scendere':
        salireScendere = 'scendere(' + (dettagli || 'N/A') + ')';
        break;
      case 'attivare':
        componenti = dettagli || 'N/A';
        break;
      case 'ricaricare':
        rifornimenti = 'ricarica(' + (dettagli || 'N/A') + ')';
        break;
      case 'cura':
        rifornimenti = 'cura';
        break;
      case 'consumare':
        rifornimenti = 'consuma(' + (quantità || 'N/A') + ')'; //da togliere
        break;
      case 'cedere':
        rifornimenti = 'cede(' + (quantità || 'N/A') + ') a ' + (target || 'N/A');
        break;
    }
    
    sheet.getRange(rowIndex + 1, 15, 1, 6).setValues([[
      'NO',
      matricola || 'N/A',
      movimento,
      salireScendere,
      componenti,
      rifornimenti
    ]]);
    
    console.log('Ordine processato: ' + tipoOrdine + ' per ' + matricola);
    return {success: true, message: 'Ordine inviato dal form: ' + tipoOrdine};
  } catch (error) {
    throw new Error('Errore ordine: ' + error.toString());
  }
}

// Registra nuova unità (da richiesta diretta)
function registerUnit(unitData) {
  try {
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    // Trova la prima riga vuota
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][1] || data[i][1] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    // Compila i dati nella riga
    sheet.getRange(rowIndex + 1, 1, 1, 12).setValues([[
      'NO', // approvata
      unitData.matricola || 'N/A',
      unitData.password || 'N/A',
      unitData.nick || 'N/A',
      unitData.tipo || 'N/A',
      'N/A', // posizione
      unitData.movimento || 'N/A',
      unitData.visione || 'N/A',
      unitData.armatura || 'N/A',
      (unitData.rifornimenti || 'N/A') + '/' + (unitData.rifornimenti || 'N/A'),
      'N/A', // trasportata
      unitData.componenti || 'N/A'
    ]]);
    
    return createResponse({success: true, message: 'Unità registrata: ' + unitData.matricola});
  } catch (error) {
    return createResponse({success: false, message: error.toString()});
  }
}

// Invia ordine (da richiesta diretta)
function submitOrder(orderData) {
  try {
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][14] || data[i][14] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    var movimento = 'N/A';
    var salireScendere = 'N/A';
    var componenti = 'N/A';
    var rifornimenti = 'N/A';
    
    switch (orderData.tipoOrdine) {
      case 'muoversi':
        movimento = orderData.dettagli || 'N/A';
        break;
      case 'salire':
        salireScendere = 'salire(' + (orderData.dettagli || 'N/A') + ')';
        break;
      case 'scendere':
        salireScendere = 'scendere(' + (orderData.dettagli || 'N/A') + ')';
        break;
      case 'attivare':
        componenti = orderData.dettagli || 'N/A';
        break;
      case 'ricaricare':
        rifornimenti = 'ricarica(' + (orderData.dettagli || 'N/A') + ')';
        break;
      case 'cura':
        rifornimenti = 'cura';
        break;
      case 'consumare':
        rifornimenti = 'consuma(' + (orderData.quantità || 'N/A') + ')';
        break;
      case 'cedere':
        rifornimenti = 'cede(' + (orderData.quantità || 'N/A') + ') a ' + (orderData.target || 'N/A');
        break;
    }
    
    sheet.getRange(rowIndex + 1, 15, 1, 6).setValues([[
      'NO',
      orderData.matricola || 'N/A',
      movimento,
      salireScendere,
      componenti,
      rifornimenti
    ]]);
    
    return createResponse({success: true, message: 'Ordine inviato: ' + orderData.tipoOrdine});
  } catch (error) {
    return createResponse({success: false, message: error.toString()});
  }
}

// Funzione helper per estrarre valori dal testo
function extractValue(text, key) {
  var startIndex = text.indexOf(key);
  if (startIndex === -1) return null;
  
  startIndex += key.length;
  var endIndex = text.indexOf(',', startIndex);
  if (endIndex === -1) endIndex = text.length;
  
  return text.substring(startIndex, endIndex).trim();
}

// Salva dati raw dal form (per debug)
function saveRawFormData(formText) {
  try {
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][17] || data[i][17] === '') { // Usa una colonna libera
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex !== -1) {
      sheet.getRange(rowIndex + 1, 18).setValue(formText); // Colonna R
    }
  } catch (error) {
    Logger.log('Errore salvataggio raw data: ' + error.toString());
  }
}

// Crea risposta standard
function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}