// Configurazione
var SHEET_ID = '1djpONz3rJtEce-bl4Wsy1q46NRl1jTMC3uKxN1hQMng'; // Il tuo foglio esistente
var RESPONSE_SHEET_NAME = 'Risposte del modulo 1'; // Foglio delle risposte del form

function doPost(e) {
  try {
    // Gestione CORS per preflight
    if (e && e.parameter && e.parameter.method === 'OPTIONS') {
      return ContentService.createTextOutput('')
        .setMimeType(ContentService.MimeType.TEXT);
    }
    
    // Gestione da Google Forms - Legge dalla colonna B del foglio risposte
    if (e.postData && e.postData.type === 'application/x-www-form-urlencoded') {
      return processAllFormResponses();
    }
    
    // Gestione normale da fetch
    if (e.postData && e.postData.type === 'application/json') {
      var data = JSON.parse(e.postData.contents);
      var action = data.action;
      
      if (action === 'register') {
        return registerUnit(data.data);
      } else if (action === 'submitOrder') {
        return submitOrder(data.data);
      }
    }
    
    return createResponse({success: false, message: 'Richiesta non valida'});
    
  } catch (error) {
    return createResponse({success: false, message: error.toString()});
  }
}

// Processa tutte le risposte dal foglio del modulo
function processAllFormResponses() {
  try {
    var responseSheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(RESPONSE_SHEET_NAME);
    var responses = responseSheet.getRange('B2:B' + responseSheet.getLastRow()).getValues();
    
    var processedCount = 0;
    var errors = [];
    
    for (var i = 0; i < responses.length; i++) {
      var formText = responses[i][0];
      
      // Salta righe vuote
      if (!formText || formText === '') continue;
      
      try {
        // Processa ogni risposta
        if (formText.includes('REGISTRAZIONE')) {
          processRegistrationFromForm(formText);
          processedCount++;
        } else if (formText.includes('ORDINE')) {
          processOrderFromForm(formText);
          processedCount++;
        } else {
          saveRawFormData(formText);
          processedCount++;
        }
        
        // Opzionale: marca come processato in una colonna adiacente
        // responseSheet.getRange(i + 2, 3).setValue('PROCESSATO');
        
      } catch (error) {
        errors.push('Riga ' + (i + 2) + ': ' + error.toString());
      }
    }
    
    return createResponse({
      success: true, 
      message: 'Processate ' + processedCount + ' risposte',
      errors: errors.length > 0 ? errors : null
    });
    
  } catch (error) {
    return createResponse({success: false, message: error.toString()});
  }
}

// Processa registrazione dal form testo
function processRegistrationFromForm(formText) {
  try {
    // Estrai i dati dal testo
    var matricola = extractValue(formText, 'Matricola:');
    var nick = extractValue(formText, 'Nick:');
    var tipo = extractValue(formText, 'Tipo:');
    var movimento = extractValue(formText, 'Movimento:');
    var visione = extractValue(formText, 'Visione:');
    var armatura = extractValue(formText, 'Armatura:');
    var rifornimenti = extractValue(formText, 'Rifornimenti:');
    
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    // Trova la prima riga vuota
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][1] || data[i][1] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    // Compila i dati nella riga
    sheet.getRange(rowIndex + 1, 1, 1, 12).setValues([[
      'NO', // approvata
      matricola || 'N/A',
      'HASHED_FROM_FORM', // Password hashed dall'HTML
      nick || 'N/A',
      tipo || 'N/A',
      'N/A', // posizione
      movimento || 'N/A',
      visione || 'N/A',
      armatura || 'N/A',
      (rifornimenti || 'N/A') + '/' + (rifornimenti || 'N/A'),
      'N/A', // trasportata
      'N/A'  // componenti
    ]]);
    
    return {success: true, message: 'Unità registrata dal form: ' + matricola};
  } catch (error) {
    throw new Error('Errore registrazione: ' + error.toString());
  }
}

// Processa ordine dal form testo
function processOrderFromForm(formText) {
  try {
    // Estrai i dati dal testo
    var matricola = extractValue(formText, 'Matricola:');
    var tipoOrdine = extractValue(formText, 'Tipo:');
    var dettagli = extractValue(formText, 'Dettagli:');
    var target = extractValue(formText, 'Target:');
    var quantità = extractValue(formText, 'Quantità:');
    
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][14] || data[i][14] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    var movimento = 'N/A';
    var salireScendere = 'N/A';
    var componenti = 'N/A';
    var rifornimenti = 'N/A';
    
    switch (tipoOrdine) {
      case 'muoversi':
        movimento = dettagli || 'N/A';
        break;
      case 'salire':
        salireScendere = 'salire(' + (dettagli || 'N/A') + ')';
        break;
      case 'scendere':
        salireScendere = 'scendere(' + (dettagli || 'N/A') + ')';
        break;
      case 'attivare':
        componenti = dettagli || 'N/A';
        break;
      case 'ricaricare':
        rifornimenti = 'ricarica(' + (dettagli || 'N/A') + ')';
        break;
      case 'cura':
        rifornimenti = 'cura';
        break;
      case 'consumare':
        rifornimenti = 'consuma(' + (quantità || 'N/A') + ')'; //da togliere
        break;
      case 'cedere':
        rifornimenti = 'cede(' + (quantità || 'N/A') + ') a ' + (target || 'N/A');
        break;
    }
    
    sheet.getRange(rowIndex + 1, 15, 1, 6).setValues([[
      'NO',
      matricola || 'N/A',
      movimento,
      salireScendere,
      componenti,
      rifornimenti
    ]]);
    
    return {success: true, message: 'Ordine inviato dal form: ' + tipoOrdine};
  } catch (error) {
    throw new Error('Errore ordine: ' + error.toString());
  }
}

// Registra nuova unità (da richiesta diretta)
function registerUnit(unitData) {
  try {
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    // Trova la prima riga vuota
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][1] || data[i][1] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    // Compila i dati nella riga
    sheet.getRange(rowIndex + 1, 1, 1, 12).setValues([[
      'NO', // approvata
      unitData.matricola || 'N/A',
      unitData.password || 'N/A',
      unitData.nick || 'N/A',
      unitData.tipo || 'N/A',
      'N/A', // posizione
      unitData.movimento || 'N/A',
      unitData.visione || 'N/A',
      unitData.armatura || 'N/A',
      (unitData.rifornimenti || 'N/A') + '/' + (unitData.rifornimenti || 'N/A'),
      'N/A', // trasportata
      unitData.componenti || 'N/A'
    ]]);
    
    return createResponse({success: true, message: 'Unità registrata: ' + unitData.matricola});
  } catch (error) {
    return createResponse({success: false, message: error.toString()});
  }
}

// Invia ordine (da richiesta diretta)
function submitOrder(orderData) {
  try {
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][14] || data[i][14] === '') {
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex === -1) rowIndex = data.length;
    
    var movimento = 'N/A';
    var salireScendere = 'N/A';
    var componenti = 'N/A';
    var rifornimenti = 'N/A';
    
    switch (orderData.tipoOrdine) {
      case 'muoversi':
        movimento = orderData.dettagli || 'N/A';
        break;
      case 'salire':
        salireScendere = 'salire(' + (orderData.dettagli || 'N/A') + ')';
        break;
      case 'scendere':
        salireScendere = 'scendere(' + (orderData.dettagli || 'N/A') + ')';
        break;
      case 'attivare':
        componenti = orderData.dettagli || 'N/A';
        break;
      case 'ricaricare':
        rifornimenti = 'ricarica(' + (orderData.dettagli || 'N/A') + ')';
        break;
      case 'cura':
        rifornimenti = 'cura';
        break;
      case 'consumare':
        rifornimenti = 'consuma(' + (orderData.quantità || 'N/A') + ')';
        break;
      case 'cedere':
        rifornimenti = 'cede(' + (orderData.quantità || 'N/A') + ') a ' + (orderData.target || 'N/A');
        break;
    }
    
    sheet.getRange(rowIndex + 1, 15, 1, 6).setValues([[
      'NO',
      orderData.matricola || 'N/A',
      movimento,
      salireScendere,
      componenti,
      rifornimenti
    ]]);
    
    return createResponse({success: true, message: 'Ordine inviato: ' + orderData.tipoOrdine});
  } catch (error) {
    return createResponse({success: false, message: error.toString()});
  }
}

// Funzione helper per estrarre valori dal testo
function extractValue(text, key) {
  var startIndex = text.indexOf(key);
  if (startIndex === -1) return null;
  
  startIndex += key.length;
  var endIndex = text.indexOf(',', startIndex);
  if (endIndex === -1) endIndex = text.length;
  
  return text.substring(startIndex, endIndex).trim();
}

// Salva dati raw dal form (per debug)
function saveRawFormData(formText) {
  try {
    var sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Foglio1');
    var data = sheet.getDataRange().getValues();
    
    var rowIndex = -1;
    for (var i = 2; i < data.length; i++) {
      if (!data[i][17] || data[i][17] === '') { // Usa una colonna libera
        rowIndex = i;
        break;
      }
    }
    
    if (rowIndex !== -1) {
      sheet.getRange(rowIndex + 1, 18).setValue(formText); // Colonna R
    }
  } catch (error) {
    Logger.log('Errore salvataggio raw data: ' + error.toString());
  }
}

// Crea risposta standard
function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}