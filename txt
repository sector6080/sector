// CARICAMENTO DATI - VERSIONE MIGLIORATA
async function loadAllData() {
    showNotification('üîÑ Caricamento dati in corso...', 'warning');
    
    try {
        // PRIMA PROVA: Fetch diretto con CORS
        console.log('Tentativo fetch diretto...');
        const response = await fetch(API_URL, {
            method: 'GET',
            mode: 'cors',
            headers: {
                'Accept': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            processLoadedData(data);
            return;
        }
    } catch (fetchError) {
        console.log('Fetch diretto fallito:', fetchError);
    }
    
    try {
        // SECONDA PROVA: JSONP come fallback
        console.log('Tentativo JSONP...');
        await loadDataWithJSONP();
    } catch (jsonpError) {
        console.log('JSONP fallito:', jsonpError);
        
        // TERZA PROVA: Mock data per testing
        showNotification('‚ö†Ô∏è Usando dati di test', 'warning');
        loadMockData();
    }
}

function processLoadedData(data) {
    if (data && data.success && Array.isArray(data.data)) {
        allUnits = data.data;
        approvedUnits = allUnits.filter(unit => unit.approvata === 'si');
        updateStats();
        loadUnits();
        loadApprovedUnits();
        showNotification(`‚úÖ Caricati ${allUnits.length} unit√†`, 'success');
        console.log('Dati caricati:', allUnits);
    } else {
        throw new Error('Formato dati non valido');
    }
}

function loadDataWithJSONP() {
    return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now();
        const timeoutId = setTimeout(() => {
            reject(new Error('Timeout JSONP'));
        }, 10000);

        window[callbackName] = function(data) {
            clearTimeout(timeoutId);
            try {
                processLoadedData(data);
                resolve(data);
            } catch (error) {
                reject(error);
            }
            delete window[callbackName];
            document.getElementById('jsonpScript')?.remove();
        };

        const script = document.createElement('script');
        script.id = 'jsonpScript';
        script.src = `${API_URL}?callback=${callbackName}`;
        script.onerror = () => {
            clearTimeout(timeoutId);
            reject(new Error('Errore caricamento script JSONP'));
            delete window[callbackName];
        };
        
        document.head.appendChild(script);
    });
}

// DATI DI TEST PER DEBUG
function loadMockData() {
    allUnits = [
        {
            matricola: "ABC-123",
            nick: "soldato1",
            tipo: "Fanteria",
            movimento: 5,
            visione: 3,
            armatura: 2,
            rifornimenti: 10,
            componenti: "Fucile, Kit pronto soccorso",
            approvata: "si",
            password: "hashed_password_123",
            posizione: "A1"
        },
        {
            matricola: "DEF-456",
            nick: "tankcommander",
            tipo: "Corazzata", 
            movimento: 3,
            visione: 5,
            armatura: 8,
            rifornimenti: 20,
            componenti: "Cannone, Mitragliatrice",
            approvata: "no",
            password: "hashed_password_456",
            posizione: "B2"
        }
    ];
    
    approvedUnits = allUnits.filter(unit => unit.approvata === 'si');
    updateStats();
    loadUnits();
    loadApprovedUnits();
    showNotification(`‚ö†Ô∏è Caricati ${allUnits.length} unit√† di test`, 'warning');
}